# Disable X axis if Bragg angle is not in [45, 50deg] or FE shutter is open
# TODO: test shutter
record(calcout, "$(P)disable_crystal_select_calc") {
    field(INPA, "$(P)$(M_BRAGG).RBV CP")
    field(INPB, "PA:04ID:A_BEAM_PRESENT CP")
    field(CALC, "((A <= 45) || (A >= 50)) || B")
    field(OUT, "$(P)$(M_X)_able.VAL PP")
}

# Determines the currently selected crystal and sets $(P)CurrentCrystal accordingly
# TODO: CALC should use defined crystal positions
record(calcout, "$(P)current_crystal_calc") {
    field(INPA, "$(P)$(M_X).RBV CP")
    field(INPB, "$(P)$(M_BRAGG).HLS CP")
    field(INPC, "$(P)$(M_BRAGG).LLS CP")
    field(CALC, "((A < 10) && !B && !C) ? 0 : ((A > 20) && !B && !C) ? 1 : 2")
    field(OUT, "$(P)CurrentCrystal PP")
    field(PINI, 1)
}

# The currently selected crystal
record(mbbo, "$(P)CurrentCrystal") {
    field(ZRST, "SiC") # ~1mm
    field(ONST, "Si")  # ~27mm
    field(TWST, "None")
}

record(ao, "$(P)SiCPosition") {
    # ~1mm
    field(DESC, "Position of SiC crystal")
    field(PREC, 3)
}

record(ao, "$(P)SiPosition") {
    # ~27mm
    field(DESC, "Position of Si crystal")
    field(PREC, 3)
}

record(seq, "$(P)MoveToSi") {
    field(DOL0, "$(P)SiPosition.VAL")
    field(LNK0, "$(P)$(M_X).VAL")
}

record(seq, "$(P)MoveToSiC") {
    field(DOL0, "$(P)SiCPosition.VAL")
    field(LNK0, "$(P)$(M_X).VAL")
}

# automatically set soft limits for the Bragg axis based on which crystal is selected
record(calcout, "$(P)set_high_bragg_limit") {
    field(INPA, "$(P)CurrentCrystal.VAL CP")
    field(CALC, "(A == 0) ? 65 : (A == 1) ? 50 : 0")
    field(OUT, "$(P)$(M_BRAGG).HLM PP")
}

record(calcout, "$(P)set_low_bragg_limit") {
    field(INPA, "$(P)CurrentCrystal.VAL CP")
    field(CALC, "(A == 0) ? 45 : (A == 1) ? 3.5 : 0")
    field(OUT, "$(P)$(M_BRAGG).LLM PP")
}
